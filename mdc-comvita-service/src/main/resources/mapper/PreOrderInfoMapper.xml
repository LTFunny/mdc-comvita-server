<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aquilaflycloud.mdc.mapper.PreOrderInfoMapper">


    <select id="pageOrderReportList"  parameterType="com.aquilaflycloud.mdc.param.pre.ReportFormParam"
            resultType="com.aquilaflycloud.mdc.result.pre.ReportOrderPageResult">
        select
        shop_name shopName,
        sum(total_price) orderTotalPrice,
        count(id) orderNumber,
        b.refundOrderNumber refundOrderNumber,
        b.refundOrderTotalPrice refundOrderTotalPrice
        from
        pre_order_info a
        left join
        (select shop_id , sum(total_price) refundOrderTotalPrice,count(id) refundOrderNumber
        from pre_refund_order_info
        where shop_id is not null
        <if test="param.shopId != null and param.shopId != ''">
            and shop_id = #{param.shopId}
        </if>
        <if test="param.createStartTime != null">
            AND create_time <![CDATA[>=]]> #{param.createStartTime}
        </if>
        <if test="param.createEndTime != null">
            AND create_time <![CDATA[<=]]> #{param.createEndTime}
        </if>
        group by shop_id
        ) b on a.shop_id=b.shop_id
        where a.order_state not in (1)
        <if test="param.shopId != null and param.shopId != ''">
            and a.shop_id = #{param.shopId}
        </if>
        <if test="param.createStartTime != null">
            AND a.create_time <![CDATA[>=]]> #{param.createStartTime}
        </if>
        <if test="param.createEndTime != null">
            AND a.create_time <![CDATA[<=]]> #{param.createEndTime}
        </if>
        group by a.shop_id
    </select>
    <select id="achievementsGuide"  parameterType="com.aquilaflycloud.mdc.param.pre.ReportFormParam"
            resultType="com.aquilaflycloud.mdc.result.pre.ReportGuidePageResult">
        select
        a.guide_name guideName,
        count(a.id)-b.refundOrderNumber  orderNumber,
        sum(a.total_price)-b.refundOrderTotalPrice  orderPrice
        from pre_order_info a
        left join (
        select guide_id , sum(total_price) refundOrderTotalPrice,count(id) refundOrderNumber
        from pre_refund_order_info
        where guide_id is not null
        <if test="param.guideName != null and param.guideName != ''">
            and guide_name = #{param.guideName}
        </if>
        <if test="param.createStartTime != null">
            AND create_time <![CDATA[>=]]> #{param.createStartTime}
        </if>
        <if test="param.createEndTime != null">
            AND create_time <![CDATA[<=]]> #{param.createEndTime}
        </if>
        group by guide_id
        )b on b.guide_id=a.guide_id
        where a.order_state=6
        <if test="param.guideName != null and param.guideName != ''">
            and a.guide_name = #{param.guideName}
        </if>
        <if test="param.createStartTime != null">
            AND a.create_time <![CDATA[>=]]> #{param.createStartTime}
        </if>
        <if test="param.createEndTime != null">
            AND a.create_time <![CDATA[<=]]> #{param.createEndTime}
        </if>
        group by a.guide_id

    </select>

    <select id="pageOrderInfoPageResult" parameterType="com.aquilaflycloud.mdc.param.pre.PreOrderInfoPageParam"
            resultType="com.aquilaflycloud.mdc.model.pre.PreOrderInfo">
        SELECT
        order_info.*
        FROM
        `pre_order_info` order_info
        <if test="param.after == 1">
            RIGHT JOIN `pre_refund_order_info` refund
            ON order_info.id = refund.order_id
        </if>
        where 1=1
        <if test="param.memberId != null and param.memberId != ''">
            and order_info.member_id = #{param.memberId}
        </if>
        <if test="param.orderState != null">
            AND order_info.order_state = #{param.orderState}
        </if>
        <if test="param.buyerPhone != null and param.buyerPhone != ''">
            AND order_info.buyer_phone = #{param.buyerPhone}
        </if>
        order by order_info.last_update_time desc
    </select>
    <select id="pageOrderPageResultList"  parameterType="com.aquilaflycloud.mdc.param.pre.AdministrationListParam"
            resultType="com.aquilaflycloud.mdc.result.pre.OrderPageResult">
            select
                a.delivery_district  deliveryDistrict,
                a.delivery_province deliveryProvince,
                a.delivery_city deliveryCity,
                a.order_code orderCode,
                a.create_time createTime,
                a.reserve_start_time reserveStartTime,
                a.delivery_time takeTime,
                b.order_state orderState,
                a.reserve_id memberId,
                a.reserve_name buyerName,
                a.reserve_phone buyerPhone,
                a.reserve_shop shopName,
                a.guide_name guideName,
                a.goods_code goodsCode,
                a.goods_name goodsName,
                count(a.id) orderNumber,
                a.goods_price goodsPrice,
                a.goods_price unitPrice
            from
            pre_order_goods a
            left join pre_order_info b on b.id=a.order_id
            where id is not null
        <if test="param.shopId != null and param.shopId != ''">
            and a.shop_id= #{param.shopId}
        </if>
        <if test="param.guideName != null and param.guideName != ''">
            and  a.guide_name= #{param.guideName}
        </if>
        <if test="param.orderState != null and param.orderState != ''">
            and  b.order_state= #{param.orderState.type}
        </if>
        <if test="param.orderCode != null and param.orderCode != ''">
            and  a.order_code= #{param.orderCode}
        </if>
        <if test="param.buyerName != null and param.buyerName != ''">
            and  a.reserve_name= #{param.buyerName}
        </if>
        <if test="param.createStartTime != null">
            AND a.create_time <![CDATA[>=]]> #{param.createStartTime}
        </if>
        <if test="param.createEndTime != null">
            AND a.create_time <![CDATA[<=]]> #{param.createEndTime}
        </if>
        order by  a.create_time desc
    </select>
    <select id="pageSalePageResultList"  parameterType="com.aquilaflycloud.mdc.param.pre.AdministrationListParam"
            resultType="com.aquilaflycloud.mdc.result.pre.SalePageResult">
        select
        a.buyer_district  deliveryDistrict,
        a.buyer_province deliveryProvince,
        a.buyer_city deliveryCity,
        a.order_code orderCode,
        a.shopName shopName,
        a.order_state orderState,
        a.guide_name guideName,
        a.goods_code goodsCode,
        a.goods_name goodsName,
        c.num orderNumber,
        b.goods_price goodsPrice,
        b.goods_price unitPrice,
        a.total_price totaGoodsPrice
        from
        pre_order_info a
        left join pre_goods_info b on b.goods_code=a.goods_code
        left join (select count(id) num,order_id orderId
        from pre_order_goods where goods_type not in (2) ) c on c.orderId=a.id
        where id is not null
        <if test="param.shopId != null and param.shopId != ''">
            and a.shop_id= #{param.shopId}
        </if>

        <if test="param.guideName != null and param.guideName != ''">
            and  a.guide_name= #{param.guideName}
        </if>
        <if test="param.orderState != null and param.orderState != ''">
            and  a.order_state= #{param.orderState.type}
        </if>
        <if test="param.orderCode != null and param.orderCode != ''">
            and  a.order_code= #{param.orderCode}
        </if>
        <if test="param.buyerName != null and param.buyerName != ''">
            and  a.buyer_name= #{param.buyerName}
        </if>
        <if test="param.createStartTime != null">
            AND a.create_time <![CDATA[>=]]> #{param.createStartTime}
        </if>
        <if test="param.createEndTime != null">
            AND a.create_time <![CDATA[<=]]> #{param.createEndTime}
        </if>
        order by  a.create_time desc

    </select>
</mapper>
